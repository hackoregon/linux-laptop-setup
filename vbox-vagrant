#! /bin/bash

# add the Oracle repository and key
sudo cp virtualbox.list /etc/apt/sources.list.d/
wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add -
sudo apt-get update && sudo apt-file update

# install VirtualBox
sudo apt install -y virtualbox-5.1 dkms gdebi

# what machine have we got?
if [ `uname -m` == "i686" ]
then
  export ARCH=i686
else
  export ARCH=x86_64
fi
echo  "Machine is ${ARCH}"

# get the package from HashiCorp's download page
export PAGE="https://www.vagrantup.com/downloads.html"
export SEEKING="https://releases.hashicorp.com/vagrant/.*${ARCH}\.deb"
export LTRIM="s;^.*href=\";;"
export RTRIM="s;${ARCH}\.deb.*$;${ARCH}\.deb;"
export PACKAGE=`curl -Ls ${PAGE} | grep -e ${SEEKING} | sed -e ${LTRIM} | sed -e ${RTRIM}`
echo "Package is ${PACKAGE}"

pushd ~/Downloads
rm -f vagrant*.deb
wget -q ${PACKAGE}
sudo gdebi --non-interactive vagrant*.deb
popd

sudo gpasswd -a ${USER} vboxusers
echo "Log out and back in to join the 'vboxusers' group!"
